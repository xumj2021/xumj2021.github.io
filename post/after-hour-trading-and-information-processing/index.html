<!DOCTYPE html>
<html lang="en-us">
<head>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-309KENXF47"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-309KENXF47');
    </script>

    
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/katex.min.css" integrity="sha384-Juol1FqnotbkyZUT5Z7gUPjQ9gzlwCENvUZTpQBAPxtusdwFLRy382PSDx5UUJ4/" crossorigin="anonymous">

    
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/katex.min.js" integrity="sha384-97gW6UIJxnlKemYavrqDHSX3SiygeOwIZhwyOKRfSaf0JWKRVj9hLASHgFTzT+0O" crossorigin="anonymous"></script>

    
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Democratize Data For Insights">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://raw.githubusercontent.com/xumj2021/Imgs/main/wp.png">
    <meta property="twitter:image" content="https://raw.githubusercontent.com/xumj2021/Imgs/main/wp.png" />
    

    
    <meta name="title" content="When Earnings Announcements Go After 4 PM" />
    <meta property="og:title" content="When Earnings Announcements Go After 4 PM" />
    <meta property="twitter:title" content="When Earnings Announcements Go After 4 PM" />
    

    
    <meta name="description" content="Analyse minute-level price discovery in after-hour market">
    <meta property="og:description" content="Analyse minute-level price discovery in after-hour market" />
    <meta property="twitter:description" content="Analyse minute-level price discovery in after-hour market" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="Mengjie, Xu, Python, Stata, SAS, Econometrics, Accounting, Crawling">
    <link rel="shortcut icon" href="/img/favicon.png.ico">

    <title>Mengjie Xu | Democratize Data For Insights</title>

    <link rel="canonical" href="/post/after-hour-trading-and-information-processing/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link rel="stylesheet" href="/css/font-awesome.all.min.css">

    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    <script src="/js/lazysizes.min.js"></script>

    
    

</head>






<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Home</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                       
                    </li>
                    
                        
                        <li>
                            <a href="/categories/anecdotes/">anecdotes</a>
                        </li>
                        
                        <li>
                            <a href="/categories/crawler/">crawler</a>
                        </li>
                        
                        <li>
                            <a href="/categories/data/">data</a>
                        </li>
                        
                        <li>
                            <a href="/categories/theory/">theory</a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/top/about//">ABOUT</a></li>
                    
		            <li>
                       
		           </li>
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('https://raw.githubusercontent.com/xumj2021/Imgs/main/wp.png')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/price-discovery" title="Price Discovery">
                            Price Discovery
                        </a>
                        
                        <a class="tag" href="/tags/after-hour-market" title="After-hour Market">
                            After-hour Market
                        </a>
                        
                    </div>
                    <h1>When Earnings Announcements Go After 4 PM</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                Mengjie Xu
                             
                            on 
                            Monday, July 1, 2024
                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <h2 id="introduction">Introduction</h2>
<p>Unlike the market during trading hours, the after-hours market is characterized by an illiquid trading environment, high trading costs, a high degree of information asymmetry, low trading volume, and most importantly, relatively &lsquo;inactive&rsquo; market participants (Barclay and Hendershott, 2004 JF), all making it challenging to trace information incorporation and price discovery in the after-hours market.</p>
<p>On the other hand, to avoid the excess volatility during the trading hours and allow more time for investors to acquire and integrate the information into their valuation assessments, firms and regulators have become more prone to release material news outside trading hours in recent years. Take the firms&rsquo; earnings announcements as an example. Figure 1 from Chan and Marsh (2024, WP) plots the intraday distribution of earnings announcement frequencies during October 2004 and December 2020. In contrast to the situation decades ago, when over 80% of earnings announcements were released during trading hours (Patell and Wolfson, 1982 TAR), after-hour earnings announcements have become dominant nowadays.</p>
<p>In this blog post, I will introduce how to trace minute-level price discovery in the after-hours market, thereby generating insights into how material news released after 4:00 p.m. is incorporated into stock prices.</p>
<center>
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" 
    src="https://raw.githubusercontent.com/xumj2021/Imgs/main/blogfilev4.jpg" width=800 height=450>
    <br>
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">Figure 1: Intraday Distribution of Eearnings Announcements (Chan and Marsh, 2024 WP)</div>
</center>
<h2 id="global-data-input">Global Data Input</h2>
<p>My global input file <code>cq_tsymbol_date.txt</code> in this blog post is a dataset with three columns, <code>Ticker</code>, <code>Dates</code> and <code>Surprise</code>. This dataset has 10,742 observations, covering 1,496 distinct stock tickers (<code>ticker</code>) and 722 distinct earnings announcement dates (<code>dates</code>) spanning from 2015 to 2018. On the other hand, 72.50% of observations have earnings <code>Surprise</code> greater than or equal to 0 in this sample, which means these firms meet or beat the mean analyst forecast.</p>
<p>As these earnings announcements are all released between 4:00 p.m. and 4:15 p.m., I am particularly interested in how the stock prices change since 4:00 p.m.</p>
<table>
<thead>
<tr>
<th style="text-align:center">Ticker</th>
<th style="text-align:center">Dates</th>
<th style="text-align:center">Surprise</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">LNDC</td>
<td style="text-align:center">20150106</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">SHLM</td>
<td style="text-align:center">20150106</td>
<td style="text-align:center">0.01</td>
</tr>
<tr>
<td style="text-align:center">…</td>
<td style="text-align:center">…</td>
<td style="text-align:center">…</td>
</tr>
<tr>
<td style="text-align:center">NSIT</td>
<td style="text-align:center">20160428</td>
<td style="text-align:center">-0.06</td>
</tr>
<tr>
<td style="text-align:center">SPNC</td>
<td style="text-align:center">20160428</td>
<td style="text-align:center">-0.03</td>
</tr>
<tr>
<td style="text-align:center">…</td>
<td style="text-align:center">…</td>
<td style="text-align:center">…</td>
</tr>
<tr>
<td style="text-align:center">RPAI</td>
<td style="text-align:center">20180731</td>
<td style="text-align:center">-0.01</td>
</tr>
<tr>
<td style="text-align:center">FISV</td>
<td style="text-align:center">20180731</td>
<td style="text-align:center">0.01</td>
</tr>
</tbody>
</table>
<h2 id="overarching-implementation-tips">Overarching Implementation Tips</h2>
<p>Insights from the following three papers guided and shaped the implementation of price discovery analysis for the after-hours market in this blog post.</p>
<ul>
<li>Gregoire and Martineau (2022, JAR) find that using trade prices instead of quote prices underestimates the speed and magnitude of price discovery in the after-hours market. They provide practical recommendations accordingly.</li>
<li>Holden and Jacobsen (2014, JF) caution that the NBBO (National Best Bid and Offer) order book accessible via the WRDS-TAQ database is incomplete. However, it is possible to construct the <em>complete NBBOs</em> by combining the quote records and the incomplete NBBOs.</li>
<li>Hu and Stephan (2022, TAR) highlight the necessity of paying extra attention to the highly volatile 4:00-to-4:01 p.m. period when analyzing after-hours trading.</li>
</ul>
<h3 id="trade-vs-quote-prices-gregoire-and-martineau-2022-jar">Trade vs Quote Prices (Gregoire and Martineau, 2022 JAR)</h3>
<p>The practical recommendations from Gregoire and Martineau (2022, JAR) are as follows. In the after-hours market,</p>
<ul>
<li>Use adjustments in <em>best ask</em> price to trace price discovery following <em>positive news</em> (earnings surprises), and adjustments in <em>best bid</em> price to trace price discovery following <em>negative news</em> (earnings surprises).</li>
<li>If the direction of news is not clear, use changes in <em>mid-quotes</em> instead of trade prices to trace the price discovery.</li>
</ul>
<p>According to Gregoire and Martineau (2022, JAR), the rationales are:</p>
<ul>
<li>While trade in after-hours market is indeed sparse, the placed orders with information content are not as sparse. It&rsquo;s just that many of these orders are not successfully executed.
<ul>
<li>Therefore, using trade instead of quote prices to compute returns would omit a considerable part of meaningful price discovery.</li>
</ul>
</li>
<li>In addition, there is an asymmetry in the speed of adjustment: following a positive surprise, the best ask price is adjusted much more quickly than the best bid price, and vice versa for negative surprises.
<ul>
<li>That said, conditional on the direction of news, using trade prices (or even mid-quotes) would underestimate both the speed and the magnitude of the price discovery.</li>
</ul>
</li>
</ul>
<h3 id="incomplete-nbbo-orderbook-holden-and-jacobsen-2014-jf">Incomplete NBBO Orderbook (Holden and Jacobsen, 2014 JF)</h3>
<p>As we are particularly interested in tracing the changes in the best bid and ask prices following the recommendations from Gregoire and Martineau (2022, JAR), the NBBO (National Best Bid and Offer) orderbook accessible via WRDS-TAQ database seems to be a good start.</p>
<p>However, Holden and Jacobsen (2014, JF) note that the NBBO order book from the WRDS-TAQ database does NOT contain the complete NBBO because when one exchange has both the best bid and best offer, it is only noted in the quote file, not the NBBO file. In such cases, the field “National BBO Ind” is set equal to 1 (for NYSE, AMEX, and regional stocks) or else the field “NASDAQ BBO Ind” is set equal to 4 (for NASDAQ stocks) in the quote file. The NBBO file in WRDS-TAQ database is therefore incomplete for it is missing these records. Readers can find more details in the footnotes 6 and 24 in Holden and Jacobsen (2014, JF) .</p>
<p>That said, one may need to complete NBBO order book by incorporating additional information from the quote file, if necessary. I guess a natural question here is <em>How &ldquo;incomplete&rdquo; the NBBOs readily accessible from the WRDS-TAQ database could be?</em></p>
<p>Well, it turns out that 37.63% of my 10,742 observations have quotes-free NBBO records. However, for those exposed to NBBOs from quote records, the contribution of the quote records could be significant. See the distribution of the percentage of quote records in the complete NBBO changes in the following table.</p>
<table>
<thead>
<tr>
<th></th>
<th>Mean</th>
<th>S.D.</th>
<th>P1</th>
<th>P25</th>
<th>Median</th>
<th>P75</th>
<th>P99</th>
</tr>
</thead>
<tbody>
<tr>
<td>NBBOs from Quotes (%)</td>
<td>30.19</td>
<td>29.69</td>
<td>0.00</td>
<td>0.00</td>
<td>26.90</td>
<td>52.54</td>
<td>95.40</td>
</tr>
</tbody>
</table>
<p>To directly evaluate the impact of NBBO completeness on price discovery analysis in the after-hours market, I plotted in Figure 2 the bid price adjustments relative to the price at 3:59 p.m. following negative earnings announcements in my sample (<code>qsurprise</code> = 1 in Step 5) using the COMPLETE and INCOMPLETE NBBOs, respectively (the patterns are similar for positive news). Figure 2 indicates that the incompleteness of NBBOs underestimates both the speed and magnitude of price discovery, but the magnitude seems tolerable for readers who just want a quick overview of the price discovery dynamics.</p>
<center>
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" 
    src="https://raw.githubusercontent.com/xumj2021/Imgs/main/completeimpact.png" width=800 height=550>
    <br>
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">Figure 2: Impact of NBBOs' Completeness</div>
</center>
<p>While these statistics are apparently limited to my personal sample, which is not necessarily representative, I hope they offer some relevant information for readers to decide whether it is necessary to complete the NBBOs in the after-hours market analysis.</p>
<h3 id="volatile-400-to-401-pm-period-hu-and-stephan-2022-tar">Volatile 4:00-to-4:01 p.m. Period (Hu and Stephan, 2022 TAR)</h3>
<p>Hu and Stephan (2022, TAR) pointed out that due to the design of major exchanges&rsquo; closing processes, the 4:00-to-4:01 p.m. period is much more volatile and informative than other after-market hours. The mechanics behind this highly volatile one-minute immediately after 4:00 p.m. are as follows.</p>
<p>There is a delay between the official exchange closing time of 4:00 pm and the actual market closing time, which can last from a fraction of a second to one minute. During this short-lived period, exchanges facilitate the closing auctions, and market participants can still submit or modify orders via the continuous limit order book (CLOB). Whenever material news such as an earnings announcements are released and disseminated during this brief market closing process (for a while many firms do release earnings precisely at 4:00 p.m.), speed traders are able to incorporate the news into their trading before the market closes. This can result in significant and informed price adjustments from the 4:00 pm price to the final closing price.</p>
<center>
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" 
    src="https://raw.githubusercontent.com/xumj2021/Imgs/main/closingv2.jpg" width=800 height=550>
    <br>
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">Figure 3: Market Micro-Structure for Highly Volatile 4:00-to-4:01 p.m.</div>
</center>
<p>An illustrative anecdote about this volatile market closing process comes from Ulta Salon Cosmetics &amp; Fragrance Inc. (ULTA) releasing its earnings at 4:00 p.m. on December 5, 2013. Readers can find more details in the <a href="https://www.wsj.com/articles/SB10001424052702304450904579367050946606562">Wall Street Journal&rsquo;s article</a>.</p>
<p>Although recent SEC mandates have addressed some loopholes in major exchanges&rsquo; closing procedures (e.g.,the <a href="https://listingcenter.nasdaq.com/assets/rulebook/nasdaq/rules/Issuer_Alert_2015-001.pdf">Nasdaq and NYSE&rsquo;s guidance</a> in November 2015 and the <a href="https://www.sec.gov/files/rules/sro/nyse/2017/34-82213.pdf">SEC&rsquo;s mandates in 2017</a>), I recommend readers remain cautious about the once highly volatile 4:00-to-4:01 p.m. period and separate this period from subsequent ones if necessary.</p>
<h2 id="implementation">Implementation</h2>
<p>While conceptually guided by the three papers mentioned above, the codes for after-hours price discovery analysis in this post are greatly inspired by those from Holden and Jacobsen (2014, JF), which are publicly accessible on <a href="https://host.kelley.iu.edu/cholden/">Craig Holden&rsquo;s website</a>. Although Holden and Jacobsen (2014, JF) focus on the <em>daily or monthly</em> price discovery WITHIN trading hours, many of their functions can extend to the <em>intraday after-hour analysis</em> (e.g., the removal of abnormal quote records, the calculation of time-weighted quote spreads and market depth, etc.).</p>
<h3 id="step-1-download-the-after-hours-nbbos-quotes">Step 1: Download the After-Hours NBBOs (Quotes)</h3>
<p>To start, we need to download the quotes and the NBBO (National Best Bid and Offer) orderbook, which are both available in the WRDS-TAQ database. Readers who are not familiar with WRDS-TAQ database can find background information about this database in my previous post <a href="https://mengjiexu.com/post/deal-with-high-frequency-data/">Extract High-frequency Data via PC SAS</a>.</p>
<p>The codes are as follows. Readers can replace <code>cqm_</code> with <code>nbbom_</code> to download NBBO files. Note that I use the <code>data step</code>  instead of <code>proc sql</code> here to query for the stocks releasing the earnings announcements on a specified day,  as the former has higher querying efficiency. Intuitively, the <code>data step</code> only involves picking observations with certain criteria from the daily TAQ dataset, while <code>proc sql</code> practically merges the whole daily TAQ dataset with the input data we provided. Although the difference is negligible with smaller datasets, using <code>data step</code> can be 50% faster when dealing with the large high-frequency daily TAQ dataset (over 20 GB).</p>
<p>This step will produce 722 output files named like <code>taqout_cq_yyyymmdd</code> and another 722 named like <code>taqout_nbbo_yyyymmdd</code>, each storing the after-hours quotes or nbbos for firms releasing earnings on date <code>yyyymmdd</code>.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-28">28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-29">29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-30">30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-31">31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-32">32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-33">33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-34">34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-35">35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-36">36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-37">37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-38">38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-39">39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-40">40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-41">41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-42">42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-43">43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-44">44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-45">45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-46">46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-47">47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-48">48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-49">49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-50">50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-51">51</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-52">52</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-53">53</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-54"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-54">54</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-55"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-55">55</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-56"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-56">56</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-57"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-57">57</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-58"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-58">58</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-59"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-59">59</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-60"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-60">60</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-61"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-61">61</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-62"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-62">62</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-63"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-63">63</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-64"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-64">64</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-65"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-65">65</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-66"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-66">66</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-67"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-67">67</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-68"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-68">68</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-69"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-69">69</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-70"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-70">70</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-71"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-71">71</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-72"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-72">72</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-73"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-73">73</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-74"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-74">74</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-75"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-75">75</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-76"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-76">76</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-77"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-77">77</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-78"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-78">78</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-79"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-79">79</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-80"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-80">80</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-81"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-81">81</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-82"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-82">82</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-83"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-83">83</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-84"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-84">84</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-85"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-85">85</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-86"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-86">86</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-87"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-87">87</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-88"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-88">88</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sas" data-lang="sas"><span style="display:flex;"><span><span style="color:#75715e">/* Assign the Home Directory */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">libname</span> home <span style="color:#d88200">&#34;D:\FullAuctionTAQ\TAQ_output_0411_new&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Connect To WRDS Server */</span>
</span></span><span style="display:flex;"><span><span style="color:#111">%let</span> wrds = wrds<span style="color:#ae81ff">.</span>wharton<span style="color:#ae81ff">.</span>upenn<span style="color:#ae81ff">.</span>edu <span style="color:#ae81ff">4016</span>;
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">options</span> comamid=TCP remote=WRDS;
</span></span><span style="display:flex;"><span>signon username=_prompt_<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">run;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Import first two columns of the Global Input File */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">filename</span> <span style="color:#00a8c8">input</span> <span style="color:#d88200">&#39;D:\Request After Hour Quotes\cq_tsymbol_date.txt&#39;</span><span style="color:#00a8c8">; 
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">data </span>dictionary2;
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">infile</span> <span style="color:#00a8c8">input</span> dlm = <span style="color:#d88200">&#34;,&#34;</span> dsd missover;
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">input</span> ticker $ dates yymmdd8.;
</span></span><span style="display:flex;"><span>	yyyymmdd=<span style="color:#00a8c8">input</span>(<span style="color:#00a8c8">put</span>(dates,yymmddn8.), best12.)<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">run;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Download The Quotes In After-Hours */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* The Following Codes Are Run In The WRDS Server */</span>
</span></span><span style="display:flex;"><span>rsubmit;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Upload The Imported Global Input File To WRDS Server */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">	proc upload </span>data=dictionary2 <span style="color:#00a8c8">out</span>=dictionary2<span style="color:#00a8c8">; run;</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Select Distinct Earnings Announcement Dates */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">	proc sql </span>noprint;
</span></span><span style="display:flex;"><span>	  <span style="color:#00a8c8">select</span> <span style="color:#00a8c8">distinct</span> yyyymmdd <span style="color:#00a8c8">into</span> :datesValsM separated <span style="color:#00a8c8">by</span> <span style="color:#d88200">&#39; &#39;</span> 
</span></span><span style="display:flex;"><span>	  <span style="color:#00a8c8">from</span> dictionary2<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	quit;</span>  
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Define A Function (Named Getdaily) To Download After-Hour Quotes For All Stocks */</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* With Earnings Releases On A Specified Day */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">%macro</span> getdaily(yyyymmdd);
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* Pick Out All The Observations Having Earnings Releases On The Specified */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* Day From The Imported Global Input File */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">		data </span>datainput;
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">set</span> dictionary2;
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">where</span> yyyymmdd = <span style="color:#111">&amp;yyyymmdd</span><span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">		run;</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* Select All The Distinct Stock Tickers To A Macro Variable Named Ticklist */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">		proc sql </span>noprint;
</span></span><span style="display:flex;"><span>		  <span style="color:#00a8c8">select</span> <span style="color:#00a8c8">distinct</span> ticker <span style="color:#00a8c8">into</span> :ticlist separated <span style="color:#00a8c8">by</span> <span style="color:#d88200">&#39; &#39;</span>
</span></span><span style="display:flex;"><span>		  <span style="color:#00a8c8">from</span> datainput<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">		quit;</span>  
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* Format The Macro Variable Ticklist To A String Named Ticlist_Formatted */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">		data </span><span style="color:#00a8c8">_null_</span>;
</span></span><span style="display:flex;"><span>		  <span style="color:#00a8c8">length</span> temp $<span style="color:#ae81ff">20000</span>;
</span></span><span style="display:flex;"><span>		  temp=cat(<span style="color:#d88200">&#39;&#34;&#39;</span>,<span style="color:#111">tranwrd(</span><span style="color:#d88200">&#34;</span><span style="color:#111">&amp;ticlist.</span><span style="color:#d88200">&#34;</span>,<span style="color:#d88200">&#34; &#34;</span>,<span style="color:#d88200">&#39;&#34; &#34;&#39;</span>),<span style="color:#d88200">&#39;&#34;&#39;</span>);
</span></span><span style="display:flex;"><span>		  <span style="color:#00a8c8">call</span> symput(<span style="color:#d88200">&#39;ticlist_formatted&#39;</span>,temp)<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">		run;</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* Print The Date Currently Being Processed */</span><span style="color:#00a8c8">
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">		%put </span><span style="color:#111">&amp;yyyymmdd</span><span style="color:#960050;background-color:#1e0010">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* Print The Formatted String Ticlist_Formatted */</span><span style="color:#00a8c8">
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">		%put </span><span style="color:#111">&amp;ticlist_formatted.</span><span style="color:#960050;background-color:#1e0010">;</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* Select The After-Hour Quotes Of Stocks Having Earnings Releases On That Day */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">		data </span>taqout_cq_<span style="color:#111">&amp;yyyymmdd</span>;
</span></span><span style="display:flex;"><span>	    	<span style="color:#00a8c8">set</span> taqmsec<span style="color:#ae81ff">.</span>cqm_<span style="color:#111">&amp;yyyymmdd</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">where</span> sym_root <span style="color:#00a8c8">in</span> ( <span style="color:#111">&amp;ticlist_formatted.</span>) <span style="color:#00a8c8">and</span> sym_suffix = <span style="color:#d88200">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">and</span> time_m ge <span style="color:#d88200">&#34;15:59:000&#34;</span>t;
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">format</span> date date9.;
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">format</span> time_m TIME20<span style="color:#ae81ff">.9</span><span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">		run;</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* Download The Quotes */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">		proc download </span>data=taqout_cq_<span style="color:#111">&amp;yyyymmdd</span> <span style="color:#00a8c8">out</span>=home<span style="color:#ae81ff">.</span>taqout_cq_<span style="color:#111">&amp;yyyymmdd</span><span style="color:#00a8c8">; run;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">%mend</span>;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Define The Function Iterate To Execute The Function Getdaily Day By Day */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* And Download Quotes For All Distinct Dates In The Global Input File */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">%macro</span> iterate();	
</span></span><span style="display:flex;"><span>		<span style="color:#111">%let</span> i=<span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#111">%let</span> yyyymmdd=<span style="color:#111">%scan</span>(<span style="color:#111">&amp;datesValsM</span>,<span style="color:#111">&amp;i</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">%do</span> <span style="color:#111">%while</span>(<span style="color:#d88200">&#34;</span><span style="color:#111">&amp;yyyymmdd</span><span style="color:#d88200">&#34;</span> ~= <span style="color:#d88200">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#111">%if</span> <span style="color:#111">%sysfunc</span>(<span style="color:#111">exist(</span>taqmsec<span style="color:#ae81ff">.</span>cqm_<span style="color:#111">&amp;yyyymmdd</span>)) <span style="color:#111">%then</span> <span style="color:#75af00">%getdaily</span>(<span style="color:#111">&amp;yyyymmdd</span>) ;
</span></span><span style="display:flex;"><span>		   	<span style="color:#111">%let</span> i = <span style="color:#111">%eval</span>(<span style="color:#111">&amp;i</span> + <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#111">%let</span> yyyymmdd=<span style="color:#111">%scan</span>(<span style="color:#111">&amp;datesValsM</span>,<span style="color:#111">&amp;i</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#111">%end</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#111">%mend</span>;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Execute The Function Iterate */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">%iterate</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>endrsubmit;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="step-2-clean-the-nbbos">Step 2: Clean the NBBOs</h3>
<h4 id="step-21-remove-abnormal-records">Step 2.1 Remove Abnormal Records</h4>
<p>I follow Holden and Jacobsen (2014, JF) and remove abnormal or missing nbbo records, outputing records with changes in best quote price or depth. The codes are as follows.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-1">  1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-2">  2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-3">  3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-4">  4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-5">  5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-6">  6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-7">  7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-8">  8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-9">  9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-10"> 10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-11"> 11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-12"> 12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-13"> 13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-14"> 14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-15"> 15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-16"> 16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-17"> 17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-18"> 18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-19"> 19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-20"> 20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-21"> 21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-22"> 22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-23"> 23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-24"> 24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-25"> 25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-26"> 26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-27"> 27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-28"> 28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-29"> 29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-30"> 30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-31"> 31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-32"> 32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-33"> 33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-34"> 34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-35"> 35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-36"> 36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-37"> 37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-38"> 38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-39"> 39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-40"> 40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-41"> 41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-42"> 42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-43"> 43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-44"> 44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-45"> 45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-46"> 46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-47"> 47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-48"> 48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-49"> 49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-50"> 50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-51"> 51</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-52"> 52</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-53"> 53</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-54"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-54"> 54</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-55"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-55"> 55</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-56"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-56"> 56</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-57"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-57"> 57</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-58"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-58"> 58</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-59"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-59"> 59</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-60"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-60"> 60</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-61"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-61"> 61</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-62"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-62"> 62</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-63"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-63"> 63</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-64"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-64"> 64</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-65"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-65"> 65</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-66"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-66"> 66</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-67"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-67"> 67</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-68"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-68"> 68</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-69"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-69"> 69</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-70"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-70"> 70</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-71"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-71"> 71</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-72"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-72"> 72</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-73"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-73"> 73</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-74"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-74"> 74</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-75"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-75"> 75</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-76"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-76"> 76</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-77"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-77"> 77</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-78"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-78"> 78</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-79"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-79"> 79</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-80"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-80"> 80</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-81"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-81"> 81</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-82"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-82"> 82</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-83"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-83"> 83</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-84"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-84"> 84</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-85"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-85"> 85</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-86"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-86"> 86</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-87"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-87"> 87</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-88"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-88"> 88</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-89"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-89"> 89</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-90"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-90"> 90</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-91"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-91"> 91</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-92"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-92"> 92</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-93"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-93"> 93</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-94"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-94"> 94</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-95"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-95"> 95</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-96"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-96"> 96</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-97"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-97"> 97</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-98"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-98"> 98</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-99"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-99"> 99</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-100"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-100">100</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-101"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-101">101</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-102"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-102">102</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-103"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-103">103</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-104"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-104">104</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-105"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-105">105</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-106"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-106">106</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-107"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-107">107</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-108"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-108">108</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-109"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-109">109</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-110"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-110">110</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-111"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-111">111</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-112"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-112">112</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-SAS" data-lang="SAS"><span style="display:flex;"><span><span style="color:#75715e">/* Define a function to clean nbbo for a specified date yyyymmdd */</span>
</span></span><span style="display:flex;"><span><span style="color:#111">%macro</span> cleannbbo(yyyymmdd);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Clean the DTAQ NBBO file */</span> 
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">	data </span>NBBO;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">set</span> home<span style="color:#ae81ff">.</span>taqout_nbbo_<span style="color:#111">&amp;yyyymmdd</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">/* Quote condition must be normal (i.e., A, B, H, O, R, W) */</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> Qu_Cond <span style="color:#00a8c8">not</span> <span style="color:#00a8c8">in</span> (<span style="color:#d88200">&#39;A&#39;</span>,<span style="color:#d88200">&#39;B&#39;</span>,<span style="color:#d88200">&#39;H&#39;</span>,<span style="color:#d88200">&#39;O&#39;</span>,<span style="color:#d88200">&#39;R&#39;</span>,<span style="color:#d88200">&#39;W&#39;</span>) <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">delete</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">/* If canceled then delete */</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> Qu_Cancel=<span style="color:#d88200">&#39;B&#39;</span> <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">delete</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">/* If both ask and bid are set to 0 or . then delete */</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> ask le <span style="color:#ae81ff">0</span> <span style="color:#00a8c8">and</span> bid le <span style="color:#ae81ff">0</span> <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">delete</span>;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> asksiz le <span style="color:#ae81ff">0</span> <span style="color:#00a8c8">and</span> bidsiz le <span style="color:#ae81ff">0</span> <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">delete</span>;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> ask = . <span style="color:#00a8c8">and</span> bid = . <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">delete</span>;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> asksiz = . <span style="color:#00a8c8">and</span> bidsiz = . <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">delete</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* Create spread and midpoint */</span>
</span></span><span style="display:flex;"><span>	    Spread=ask-bid;
</span></span><span style="display:flex;"><span>	    Midpoint=(ask+bid)/<span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* If size/price = 0 or . then price/size is set to . */</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> ask le <span style="color:#ae81ff">0</span> <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">do</span>;
</span></span><span style="display:flex;"><span>	        ask=.;
</span></span><span style="display:flex;"><span>	        asksiz=.;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">end</span>;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> ask=. <span style="color:#00a8c8">then</span> asksiz=.;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> asksiz le <span style="color:#ae81ff">0</span> <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">do</span>;
</span></span><span style="display:flex;"><span>	        ask=.;
</span></span><span style="display:flex;"><span>	        asksiz=.;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">end</span>;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> asksiz=. <span style="color:#00a8c8">then</span> ask=.;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> bid le <span style="color:#ae81ff">0</span> <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">do</span>;
</span></span><span style="display:flex;"><span>	        bid=.;
</span></span><span style="display:flex;"><span>	        bidsiz=.;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">end</span>;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> bid=. <span style="color:#00a8c8">then</span> bidsiz=.;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> bidsiz le <span style="color:#ae81ff">0</span> <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">do</span>;
</span></span><span style="display:flex;"><span>	        bid=.;
</span></span><span style="display:flex;"><span>	        bidsiz=.;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">end</span>;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> bidsiz=. <span style="color:#00a8c8">then</span> bid=.;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/*	Bid/Ask size are in round lots, replace with new shares variable*/</span>
</span></span><span style="display:flex;"><span>		BidsizeShares = bidsiz * <span style="color:#ae81ff">100</span>;
</span></span><span style="display:flex;"><span>		AsksizeShares = asksiz * <span style="color:#ae81ff">100</span><span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	run;</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Get Previous Midpoint */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">	proc sort </span>
</span></span><span style="display:flex;"><span>	    data=NBBO (<span style="color:#00a8c8">drop</span> = bidsiz asksiz);
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">by</span> sym_root  date<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	run;</span> 
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	data </span>NBBO2;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">set</span> NBBO;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">by</span> sym_root date;
</span></span><span style="display:flex;"><span>	    lmid=<span style="color:#111">lag(</span>Midpoint);
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> first<span style="color:#ae81ff">.</span>sym_root  <span style="color:#00a8c8">or</span> first<span style="color:#ae81ff">.</span>date <span style="color:#00a8c8">then</span> lmid=.;
</span></span><span style="display:flex;"><span>	    lm25=lmid<span style="color:#ae81ff">-2.5</span>;
</span></span><span style="display:flex;"><span>	    lp25=lmid<span style="color:#ae81ff">+2.5</span><span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	run;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* If the quoted spread is greater than $5.00 and the bid (ask) price is less
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	   (greater) than the previous midpoint - $2.50 (previous midpoint + $2.50), 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	   then the bid (ask) is not considered. */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	data </span>NBBO2;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">set</span> NBBO2;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> Spread gt <span style="color:#ae81ff">5</span> <span style="color:#00a8c8">and</span> bid lt lm25 <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">do</span>;
</span></span><span style="display:flex;"><span>	        bid=.;
</span></span><span style="display:flex;"><span>	        bidsizeShares=.;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">end</span>;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> Spread gt <span style="color:#ae81ff">5</span> <span style="color:#00a8c8">and</span> ask gt lp25 <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">do</span>;
</span></span><span style="display:flex;"><span>	        ask=.;
</span></span><span style="display:flex;"><span>	        asksizeShares=.;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">end</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> bid=. <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">delete</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> ask=. <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">delete</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">keep</span> date time_m sym_root Qu_SeqNum bid bidsizeShares 
</span></span><span style="display:flex;"><span>	         ask asksizeShares <span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	run;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Output new NBBO records - identify changes in NBBO records 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	   (changes in price and/or depth) */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	data </span>NBBO2;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">set</span> NBBO2;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> sym_root ne <span style="color:#111">lag(</span>sym_root) 
</span></span><span style="display:flex;"><span>	       <span style="color:#00a8c8">or</span> date ne <span style="color:#111">lag(</span>date) 
</span></span><span style="display:flex;"><span>	       <span style="color:#00a8c8">or</span> ask ne <span style="color:#111">lag(</span>ask) 
</span></span><span style="display:flex;"><span>	       <span style="color:#00a8c8">or</span> bid ne <span style="color:#111">lag(</span>bid) 
</span></span><span style="display:flex;"><span>	       <span style="color:#00a8c8">or</span> asksizeShares ne <span style="color:#111">lag(</span>asksizeShares) 
</span></span><span style="display:flex;"><span>	       <span style="color:#00a8c8">or</span> bidsizeShares ne <span style="color:#111">lag(</span>bidsizeShares)<span style="color:#00a8c8">; 
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	run;</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* If the NBBO contains two quotes in the exact same microsecond, assume 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	   last quote (based on sequence number) is the active one */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">	proc sort </span>data=NBBO2;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">by</span> sym_root date time_m descending Qu_SeqNum<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	run;</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	proc sort </span>data=NBBO2 nodupkey;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">by</span> sym_root date time_m<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	run;</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Save the output file as cleanednnbos_&amp;yyyymmdd */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">	data </span>home<span style="color:#ae81ff">.</span>cleanednnbos_<span style="color:#111">&amp;yyyymmdd</span> */;
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">set</span> NBBO2<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	run;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">%mend</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="step-22-obtain-the-complete-nbbo">Step 2.2: Obtain the Complete NBBO</h4>
<p>Given that the NBBO order book downloaded directly from the WRDS-TAQ database is incomplete, I follow Holden and Jacobsen (2014, JF) and complete it by incorporating additional information from quote files. Readers can find more details about this in the footnotes 6 and 24 in Holden and Jacobsen (2014, JF).</p>
<p>Note that I tag the <code>source</code> as <code>Ori_NBBO</code> if the NBBO record change is detected based on the directly accessed NBBO file from the WRDS-TAQ database, and as <code>Quotes</code> if the NBBO record change is detected based on quote records.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-28">28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-29">29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-30">30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-31">31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-32">32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-33">33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-34">34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-35">35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-36">36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-37">37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-38">38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-39">39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-40">40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-41">41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-42">42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-43">43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-44">44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-45">45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-46">46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-47">47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-48">48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-49">49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-50">50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-51">51</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-52">52</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-53">53</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-54"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-54">54</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-55"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-55">55</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-56"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-56">56</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-57"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-57">57</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-58"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-58">58</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-59"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-59">59</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-60"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-60">60</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-61"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-61">61</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-62"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-62">62</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-63"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-63">63</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-64"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-64">64</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-65"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-65">65</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-66"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-66">66</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-67"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-67">67</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-68"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-68">68</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-69"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-69">69</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-70"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-70">70</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-71"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-71">71</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-72"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-72">72</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-73"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-73">73</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-74"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-74">74</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-75"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-75">75</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-76"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-76">76</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-77"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-77">77</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-78"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-78">78</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-79"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-79">79</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-80"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-80">80</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-81"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-81">81</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-82"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-82">82</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-83"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-83">83</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-84"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-84">84</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-85"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-85">85</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sas" data-lang="sas"><span style="display:flex;"><span><span style="color:#111">%macro</span> getcompletenbbo(yyyymmdd)<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	data </span>NBBO2;
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">set</span> home<span style="color:#ae81ff">.</span>cleanednnbos_<span style="color:#111">&amp;yyyymmdd</span>;
</span></span><span style="display:flex;"><span>		source = <span style="color:#d88200">&#34;Ori_NBBO&#34;</span><span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	run;</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Clean WRDS-TAQ quotes data */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">	data </span>quoteAB;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">set</span> home<span style="color:#ae81ff">.</span>taqout_cq_<span style="color:#111">&amp;yyyymmdd</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">/* Create spread and midpoint */</span>
</span></span><span style="display:flex;"><span>	    Spread=Ask-Bid;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">/* Delete if abnormal quote conditions */</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> Qu_Cond <span style="color:#00a8c8">not</span> <span style="color:#00a8c8">in</span> (<span style="color:#d88200">&#39;A&#39;</span>,<span style="color:#d88200">&#39;B&#39;</span>,<span style="color:#d88200">&#39;H&#39;</span>,<span style="color:#d88200">&#39;O&#39;</span>,<span style="color:#d88200">&#39;R&#39;</span>,<span style="color:#d88200">&#39;W&#39;</span>) <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">delete</span>; 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">/* Delete if abnormal crossed markets */</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> Bid&gt;Ask <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">delete</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">/* Delete abnormal spreads */</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> Spread&gt;<span style="color:#ae81ff">5</span> <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">delete</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">/* Delete withdrawn quotes. This is when an exchange temporarily has no quote,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	       as indicated by quotes with price or depth fields containing values less 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	       than or equal to 0 or equal to &#39;.&#39;. See discussion in Holden and
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	       Jacobsen (2014), page 11.  */</span>
</span></span><span style="display:flex;"><span>	      
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> Ask le <span style="color:#ae81ff">0</span> <span style="color:#00a8c8">or</span> Ask =. <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">delete</span>;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> Asksiz le <span style="color:#ae81ff">0</span> <span style="color:#00a8c8">or</span> Asksiz =. <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">delete</span>;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> Bid le <span style="color:#ae81ff">0</span> <span style="color:#00a8c8">or</span> Bid =. <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">delete</span>;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> Bidsiz le <span style="color:#ae81ff">0</span> <span style="color:#00a8c8">or</span> Bidsiz =. <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">delete</span>;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">drop</span> Sym_Suffix Qu_Cancel RPI SSR FINRA_ADF_MPID SIP_Message_ID
</span></span><span style="display:flex;"><span>	         Spread NATL_BBO_LULD<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	run;</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Pick out nbbos only in quotes file */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">	data </span>quoteAB2;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">set</span> quoteAB;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">where</span> (Qu_Source = <span style="color:#d88200">&#34;C&#34;</span> <span style="color:#00a8c8">and</span> NatBBO_Ind=<span style="color:#d88200">&#39;1&#39;</span>) 
</span></span><span style="display:flex;"><span>	       <span style="color:#00a8c8">or</span> (Qu_Source = <span style="color:#d88200">&#34;N&#34;</span> <span style="color:#00a8c8">and</span> NatBBO_Ind=<span style="color:#d88200">&#39;4&#39;</span>);
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">/* Bid/Ask size are in round lots, replace with new shares variable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	       and rename Best_BidSizeShares and Best_AskSizeShares */</span>
</span></span><span style="display:flex;"><span>	    BidSizeShares = Bidsiz * <span style="color:#ae81ff">100</span>;
</span></span><span style="display:flex;"><span>	    AskSizeShares = Asksiz * <span style="color:#ae81ff">100</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		source = <span style="color:#d88200">&#34;Quote&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">keep</span> date time_m sym_root Qu_SeqNum Bid 
</span></span><span style="display:flex;"><span>	         BidSizeShares Ask AskSizeShares source<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	run;</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Combine NBBOs from two sources */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">	proc sort </span>data=NBBO2;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">by</span> sym_root date Qu_SeqNum<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	run;</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	proc sort </span>data=quoteAB2;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">by</span> sym_root date Qu_SeqNum<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	run;</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	data </span>OfficialCompleteNBBO;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">set</span> NBBO2 quoteAB2;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">by</span> sym_root date Qu_SeqNum;
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* Create spread and midpoint */</span>
</span></span><span style="display:flex;"><span>	    Spread=Ask-Bid;
</span></span><span style="display:flex;"><span>	    Midpoint=(Ask+Bid)/<span style="color:#ae81ff">2</span><span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	run;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* If the NBBO contains two quotes in the exact same microsecond, assume 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	   last quote (based on sequence number) is the active one */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">	proc sort </span>data=OfficialCompleteNBBO;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">by</span> sym_root date time_m descending Qu_SeqNum<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	run;</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	proc sort </span>data=OfficialCompleteNBBO nodupkey;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">by</span> sym_root date time_m<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	run;</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Save the output file as officialcompletenbbo_&amp;yyyymmdd */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">	data </span>home<span style="color:#ae81ff">.</span>officialcompletenbbo_<span style="color:#111">&amp;yyyymmdd</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">set</span> officialcompletenbbo<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	run;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">%mend</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="step-23-execute-the-nbbo-cleaning-functions">Step 2.3 Execute the NBBO-cleaning Functions</h4>
<p>Having defined the functions to clean NBBO files (<code>cleannbbo</code>) and to get the complete NBBOs (<code>getcompletenbbo</code>), we need to execute these functions date by date.</p>
<p>For a quick overview of the after-hours market, it seems okay to skip the completion of NBBOs. Readers who perceive sufficient to conduct analysis based on the the NBBOs directly from WRDS-TAQ database may comment line 25 in the following code block.</p>
<p>If you comment line 25, this step will produce 722 separate files with names like <code>cleanednnbos_&amp;yyyymmdd</code>, storing the cleaned NBBO records directly from WRDS-TAQ database. If you don&rsquo;t, there will be additional 722 files with names like <code>officialcompletenbbo_&amp;yyyymmdd</code>, storing  the complete NBBO records augmented from quote records.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-28">28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-29">29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-30">30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-31">31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-32">32</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sas" data-lang="sas"><span style="display:flex;"><span><span style="color:#75715e">/* Assign the Home Directory */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">libname</span> home <span style="color:#d88200">&#34;D:\FullAuctionTAQ\TAQ_output_0411_new&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Import Global Input File */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">filename</span> <span style="color:#00a8c8">input</span> <span style="color:#d88200">&#39;D:\Request After Hour Quotes\cq_tsymbol_date.txt&#39;</span><span style="color:#00a8c8">; 
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">data </span>dictionary2;
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">infile</span> <span style="color:#00a8c8">input</span> dlm = <span style="color:#d88200">&#34;,&#34;</span> dsd missover;
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">input</span> ticker $ dates yymmdd8.;
</span></span><span style="display:flex;"><span>	yyyymmdd=<span style="color:#00a8c8">input</span>(<span style="color:#00a8c8">put</span>(dates,yymmddn8.), best12.)<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">run;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Select Distinct Earnings Announcement Dates */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">proc sql </span>noprint;
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">select</span> <span style="color:#00a8c8">distinct</span> yyyymmdd <span style="color:#00a8c8">into</span> :datesValsM separated <span style="color:#00a8c8">by</span> <span style="color:#d88200">&#39; &#39;</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">from</span> dictionary2<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">quit;</span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Get Cleaned NBBOs Day by Day */</span>
</span></span><span style="display:flex;"><span><span style="color:#111">%macro</span> iteratenbbo();
</span></span><span style="display:flex;"><span>	<span style="color:#111">%let</span> i=<span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#111">%let</span> yyyymmdd=<span style="color:#111">%scan</span>(<span style="color:#111">&amp;datesValsM</span>,<span style="color:#111">&amp;i</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">%do</span> <span style="color:#111">%while</span>(<span style="color:#d88200">&#34;</span><span style="color:#111">&amp;yyyymmdd</span><span style="color:#d88200">&#34;</span> ~= <span style="color:#d88200">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">%cleannbbo</span>(<span style="color:#111">&amp;yyyymmdd</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">%getcompletenbbo</span>(<span style="color:#111">&amp;yyyymmdd</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#111">%let</span> i = <span style="color:#111">%eval</span>(<span style="color:#111">&amp;i</span> + <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#111">%let</span> yyyymmdd=<span style="color:#111">%scan</span>(<span style="color:#111">&amp;datesValsM</span>,<span style="color:#111">&amp;i</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#111">%end</span>;
</span></span><span style="display:flex;"><span><span style="color:#111">%mend</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Execute The Function Iterate */</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">%iteratenbbo</span>();
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="step-3-merge-complete-nbbos-for-analysis">Step 3: Merge (Complete) NBBOs for Analysis</h3>
<p>Up to this step, we have obtained the cleaned (complete) NBBO files by the date of earnings announcements. For ease of later analysis, I will merge all the cleaned NBBO files stored in 722 separate files into one file.</p>
<p>Implementation-wise, I first obtain all the filenames in the directory that stores the cleaned NBBO files, then select all files with names starting with <code>officialcompletenbbo</code> (or <code>cleanednnbos</code> if you commented line 25 in Step 2.3), and finally combine all the data from these selected files into one integrated file named <code>nbbos_officialcompletenbbo</code> (or <code>nbbos_cleanednnbos</code>).</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-28">28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-29">29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-30">30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-31">31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-32">32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-33">33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-34">34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-35">35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-36">36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-37">37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-38">38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-39">39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-40">40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-41">41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-42">42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-43">43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-44">44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-45">45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-46">46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-47">47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-48">48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-49">49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-50">50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-51">51</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-52">52</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-53">53</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-54"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-54">54</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-55"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-55">55</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-56"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-56">56</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-57"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-57">57</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-58"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-58">58</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sas" data-lang="sas"><span style="display:flex;"><span><span style="color:#75715e">/* Assign the Home Directory */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">libname</span> home <span style="color:#d88200">&#34;D:\FullAuctionTAQ\TAQ_output_0411_new&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Assign the same directory path to the macro variable &#39;dir&#39; */</span>
</span></span><span style="display:flex;"><span><span style="color:#111">%let</span> dir=D:\FullAuctionTAQ\TAQ_output_0411_new;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Collect all the file names in the directory */</span>
</span></span><span style="display:flex;"><span><span style="color:#111">%macro</span> collectnbbos(nbbotype);
</span></span><span style="display:flex;"><span>	<span style="color:#111">%let</span> strtype = <span style="color:#d88200">&#34;%sysfunc(tranwrd(</span><span style="color:#111">&amp;nbbotype</span><span style="color:#d88200">,%str( ),%str(%&#34;</span> %<span style="color:#d88200">&#34;)))&#34;</span><span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	data </span>files;
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">/* Initializes the file reference variable &#39;fref&#39; with the value &#34;DIR&#34; */</span>
</span></span><span style="display:flex;"><span>	    fref = <span style="color:#d88200">&#34;DIR&#34;</span>;
</span></span><span style="display:flex;"><span>	    
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">/* Checks if the directory can be assigned to the file reference variable */</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> <span style="color:#00a8c8">filename</span>(fref,<span style="color:#d88200">&#34;</span><span style="color:#111">&amp;dir.</span><span style="color:#d88200">&#34;</span>) = <span style="color:#ae81ff">0</span> <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">do</span>;
</span></span><span style="display:flex;"><span>	        <span style="color:#75715e">/* Opens the directory and assigns its ID to &#39;did&#39; */</span>
</span></span><span style="display:flex;"><span>	        did = <span style="color:#111">dopen(</span>fref);
</span></span><span style="display:flex;"><span>	        
</span></span><span style="display:flex;"><span>	        <span style="color:#75715e">/* Checks if the directory was successfully opened */</span>
</span></span><span style="display:flex;"><span>	        <span style="color:#00a8c8">if</span> did ne <span style="color:#ae81ff">0</span> <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">do</span>;
</span></span><span style="display:flex;"><span>	            <span style="color:#75715e">/* Loops through each file in the directory */</span>
</span></span><span style="display:flex;"><span>	            <span style="color:#00a8c8">do</span> i = <span style="color:#ae81ff">1</span> to <span style="color:#111">dnum(</span>did);
</span></span><span style="display:flex;"><span>	                <span style="color:#75715e">/* Reads the name of the ith file in the directory */</span>
</span></span><span style="display:flex;"><span>	                name = <span style="color:#111">dread(</span>did,i);
</span></span><span style="display:flex;"><span>	                
</span></span><span style="display:flex;"><span>	                <span style="color:#75715e">/* Checks if the file has a &#39;.sas7bdat&#39; extension (SAS dataset) */</span>
</span></span><span style="display:flex;"><span>					 <span style="color:#75715e">/* Keep files with name starting with &#39;officialcompletenbbo&#39; */</span>
</span></span><span style="display:flex;"><span>	                <span style="color:#00a8c8">if</span> <span style="color:#111">scan(</span>name,-<span style="color:#ae81ff">1</span>,<span style="color:#d88200">&#34;.&#34;</span>) = <span style="color:#d88200">&#34;sas7bdat&#34;</span> <span style="color:#00a8c8">and</span> <span style="color:#111">scan(</span>name, <span style="color:#ae81ff">1</span>, <span style="color:#d88200">&#34;_&#34;</span>) = <span style="color:#111">&amp;strtype</span> <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">output</span>;
</span></span><span style="display:flex;"><span>	            <span style="color:#00a8c8">end</span>;
</span></span><span style="display:flex;"><span>	            <span style="color:#75715e">/* Closes the directory */</span>
</span></span><span style="display:flex;"><span>	            did = <span style="color:#111">dclose(</span>did);
</span></span><span style="display:flex;"><span>	        <span style="color:#00a8c8">end</span>;
</span></span><span style="display:flex;"><span>	        <span style="color:#75715e">/* Clears the file reference variable */</span>
</span></span><span style="display:flex;"><span>	        rc = <span style="color:#00a8c8">filename</span>(fref);
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">end</span>;
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">/* Keeps only the &#39;name&#39; variable in the output dataset */</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">keep</span> name<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	run;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Add the reference library for these selected datasets */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* The results are put into a macro variable &#39;nbbolist&#39;, separated by spaces */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">	proc sql </span>noprint;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">select</span> <span style="color:#00a8c8">distinct</span> cat(<span style="color:#d88200">&#34;home.&#34;</span>, <span style="color:#111">scan(</span>name,<span style="color:#ae81ff">1</span>,<span style="color:#d88200">&#34;.&#34;</span>)) <span style="color:#00a8c8">into</span> :nbbolist separated <span style="color:#00a8c8">by</span> <span style="color:#d88200">&#39; &#39;</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">from</span> files<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	quit;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Creates a new dataset &#39;home.nbbos_&amp;nbbotype&#39; */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Sets (appends) all datasets listed in the &#39;nbbolist&#39; macro variable */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">	data </span>home<span style="color:#ae81ff">.</span>nbbos_<span style="color:#111">&amp;nbbotype</span>;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">set</span> <span style="color:#111">&amp;nbbolist</span><span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	run;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">%mend</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Execute The Function collectnbbos */</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">%collectnbbos</span>(officialcompletenbbo);
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*%collectnbbos(cleanednnbos);*/</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="step-4-output-minute-level-quote-prices-spreads-and-market-depths">Step 4: Output Minute-Level Quote Prices, Spreads, and Market Depths</h3>
<p>Now that we have all the record changes in national best bid and offers (NBBOs) during the after-hours (from 4:00 p.m. to 8:00 p.m.), we can output the data for further analysis depending on the granularity that best fits the research purpose. Given that the WRDS-TAQ database provides microsecond timestamps since July 2015 and nanosecond timestamps starting from October 2016, the nanosecond granularity could be the theoretical maximum. However, I guess most research does not need to go that far.</p>
<p>Here I will conduct the analysis in the minute level, which is presumably sufficient enough for most research purposes. For each earnings announcement in my sample, the following code will calculate the maximum time-weighted spreads and market depth within each minute, as well as the best bid/ask price at the end of each minute in after-hours. I output these prices/spreads/depths to a <code>csv</code> file named <code>QuoteSpread_officialcompletenbbo.csv</code> for subsequent drawing of stylized patterns in <code>Stata</code>.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-28">28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-29">29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-30">30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-31">31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-32">32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-33">33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-34">34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-35">35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-36">36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-37">37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-38">38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-39">39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-40">40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-41">41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-42">42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-43">43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-44">44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-45">45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-46">46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-47">47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-48">48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-49">49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-50">50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-51">51</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-52">52</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-53">53</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-54"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-54">54</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-55"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-55">55</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-56"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-56">56</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-57"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-57">57</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-58"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-58">58</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-59"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-59">59</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-60"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-60">60</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-61"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-61">61</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-62"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-62">62</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-63"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-63">63</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-64"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-64">64</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-65"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-65">65</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-66"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-66">66</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-67"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-67">67</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-68"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-68">68</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-69"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-69">69</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-70"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-70">70</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-71"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-71">71</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-72"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-72">72</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-73"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-73">73</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-74"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-74">74</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-75"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-75">75</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-76"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-76">76</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-77"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-77">77</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-78"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-78">78</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-79"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-79">79</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sas" data-lang="sas"><span style="display:flex;"><span><span style="color:#111">%macro</span> getquotedspreads(nbbotype);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Determine the trading minute relative to 4 p.m. */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">    data </span>NBBO2;
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">set</span> home<span style="color:#ae81ff">.</span>nbbos_<span style="color:#111">&amp;nbbotype</span>;
</span></span><span style="display:flex;"><span>        min = <span style="color:#111">floor(</span>(time_m-<span style="color:#d88200">&#34;16:00:00.000000000&#34;</span>t)/<span style="color:#ae81ff">60</span>)<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">    run;</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Time each quote is in force - if last quote of the minute, then quote is */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* inforce until the beginning of the next mminute */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">    proc sort </span>data=NBBO2;
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">by</span> sym_root date min descending time_m<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">    run;</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	data </span>QSpread1;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">set</span> NBBO2;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">by</span> sym_root date min;
</span></span><span style="display:flex;"><span>		benchtime = <span style="color:#d88200">&#34;16:00:00.000000000&#34;</span>t<span style="color:#ae81ff">+60</span>*(min<span style="color:#ae81ff">+1</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">format</span> benchtime time20<span style="color:#ae81ff">.3</span>;
</span></span><span style="display:flex;"><span>		inforce=<span style="color:#111">abs(dif(</span>time_m));
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> first<span style="color:#ae81ff">.</span>min
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">then</span> inforce=benchtime-time_m;
</span></span><span style="display:flex;"><span>		midquote=(ask+bid)/<span style="color:#ae81ff">2</span><span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	run;</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">	
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	data </span>QSpread2;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">set</span> QSpread1;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* Delete Locked and Crossed Quotes */</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> ask=bid <span style="color:#00a8c8">or</span> ask&lt;bid <span style="color:#00a8c8">then</span> <span style="color:#00a8c8">delete</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* Multiply Dollar Quoted Spread, Percent Quoted Spread, Best Dollar 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	   	Depth, and Best Share Depth by time_m Inforce */</span>
</span></span><span style="display:flex;"><span>	    wQuotedSpread_Dollar=(ask-bid)*inforce;
</span></span><span style="display:flex;"><span>	    wQuotedSpread_Percent=(<span style="color:#111">log(</span>ask)-<span style="color:#111">log(</span>bid))*inforce;
</span></span><span style="display:flex;"><span>	    wBestOfrDepth_Dollar=ask*asksizeShares*inforce;
</span></span><span style="display:flex;"><span>	    wBestBidDepth_Dollar=bid*bidsizeShares*inforce;
</span></span><span style="display:flex;"><span>	    wBestOfrDepth_Share=asksizeShares*inforce;
</span></span><span style="display:flex;"><span>	    wBestBidDepth_Share=bidsizeShares*inforce<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	run;</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	proc sql;</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">create</span> <span style="color:#00a8c8">table</span> QuotedSpreadsandDepths 
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">/* Find Average for spreads/depths and last record for quote price */</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">/* Across Firm-Min */</span> 
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">select</span> sym_root,date,min,bid,ask,midquote,time_m,
</span></span><span style="display:flex;"><span>	    <span style="color:#111">sum(</span>inforce) <span style="color:#00a8c8">as</span> sumtime,
</span></span><span style="display:flex;"><span>	    <span style="color:#111">sum(</span>wQuotedSpread_Dollar) <span style="color:#00a8c8">as</span> swQuotedSpread_Dollar,
</span></span><span style="display:flex;"><span>	    <span style="color:#111">sum(</span>wQuotedSpread_Percent) <span style="color:#00a8c8">as</span> swQuotedSpread_Percent,
</span></span><span style="display:flex;"><span>	    <span style="color:#111">sum(</span>wBestOfrDepth_Dollar) <span style="color:#00a8c8">as</span> swBestOfrDepth_Dollar,
</span></span><span style="display:flex;"><span>	    <span style="color:#111">sum(</span>wBestBidDepth_Dollar) <span style="color:#00a8c8">as</span> swBestBidDepth_Dollar,
</span></span><span style="display:flex;"><span>	    <span style="color:#111">sum(</span>wBestOfrDepth_Share) <span style="color:#00a8c8">as</span> swBestOfrDepth_Share,
</span></span><span style="display:flex;"><span>	    <span style="color:#111">sum(</span>wBestBidDepth_Share) <span style="color:#00a8c8">as</span> swBestBidDepth_Share 
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">from</span> QSpread2 
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">group</span> <span style="color:#00a8c8">by</span> sym_root,date,min 
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">having</span> time_m=<span style="color:#111">max(</span>time_m)<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	quit;</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Calculate Time-Weighted Dollar Quoted Spread, Percent Quoted Spread, 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	   Best Dollar Depth, and Best Share Depth */</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">	data </span>home<span style="color:#ae81ff">.</span>QuoteSpread_<span style="color:#111">&amp;nbbotype</span>;
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">set</span> QuotedSpreadsandDepths;
</span></span><span style="display:flex;"><span>	    QuotedSpread_Dollar=swQuotedSpread_Dollar/sumtime;
</span></span><span style="display:flex;"><span>	    QuotedSpread_Percent=swQuotedSpread_Percent/sumtime;
</span></span><span style="display:flex;"><span>	    BestOfrDepth_Dollar=swBestOfrDepth_Dollar/sumtime;
</span></span><span style="display:flex;"><span>	    BestBidDepth_Dollar=swBestBidDepth_Dollar/sumtime;
</span></span><span style="display:flex;"><span>	    BestOfrDepth_Share=swBestOfrDepth_Share/sumtime;
</span></span><span style="display:flex;"><span>	    BestBidDepth_Share=swBestBidDepth_Share/sumtime;
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">drop</span> swQuotedSpread_Dollar swQuotedSpread_Percent 
</span></span><span style="display:flex;"><span>	         swBestOfrDepth_Dollar swBestBidDepth_Dollar
</span></span><span style="display:flex;"><span>	         swBestOfrDepth_Share swBestBidDepth_Share<span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	run;</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Output to CSV file */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">%let</span> outfile = <span style="color:#111">%sysfunc</span>(cat(D:\FullAuctionTAQ\TAQ_output_0411_new\QuoteSpread_, <span style="color:#111">&amp;nbbotype</span>, .csv));
</span></span><span style="display:flex;"><span>	<span style="color:#111">%let</span> outfile = <span style="color:#d88200">&#34;%sysfunc(tranwrd(</span><span style="color:#111">&amp;outfile</span><span style="color:#d88200">,%str( ),%str(%&#34;</span> %<span style="color:#d88200">&#34;)))&#34;</span><span style="color:#00a8c8">;
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">	proc export </span>data=home<span style="color:#ae81ff">.</span>QuoteSpread_<span style="color:#111">&amp;nbbotype</span> outfile=<span style="color:#111">&amp;outfile</span> dbms=csv <span style="color:#00a8c8">replace</span><span style="color:#00a8c8">; run;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">%mend</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">%getquotedspreads</span>(officialcompletenbbo);
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*%getquotedspreads(cleanednnbos);*/</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="step-5-draw-stylized-patterns">Step 5: Draw Stylized Patterns</h3>
<p>Here, readers can already fit the data outputs to their research agenda already. To provide an example, I draw the bid price changes for negative earnings surprises and the ask price changes for positive earnings surprises, respectively, similar to what Gregoire and Martineau (2022, JAR) did.</p>
<p>In particular, I group my firm-date observations into three ranked groups based on the earnings surprises, <code>Surprise</code>. The dummy variable <code>qsurprise</code> equals 1 for firms with the lowest <code>Surprise</code> and therefore the most negative news, and 3 for firms with the highest <code>Surprise</code> and therefore the most positive news. Then I plotted in Figure 4 the minute-level quote price changes for positive (<code>qsurprise</code>=3) and negative news  (<code>qsurprise</code>=1) respectively.</p>
<p>Patterns in Figure 4 kind of validate my methods in this post.</p>
<ul>
<li>Consistent with Gregoire and Martineau (2022, JAR), they show that it would be better to use bid price changes for tracking price discovery after bad news, and ask price changes for positive news. Using mid-quotes underestimates both the speed and magnitude of price discovery regardless of the news direction, not to mention when using trade prices.</li>
<li>Consistent with Hu and Stephan (2022, TAR) , they show that there is a considerable price jump in the first minute following 4:00 p.m. More importantly, these price jumps seems to be highly informed, as they are consistent with the news directions.</li>
</ul>
<center>
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" 
    src="https://raw.githubusercontent.com/xumj2021/Imgs/main/quoteprcv2.png" width=800 height=450>
    <br>
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">Figure 4: Minute-level Quote Price Changes Following Earnings Announcements in After-hours</div>
</center>
<p>The codes for drawing these patterns are as follows.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-28">28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-29">29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-30">30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-31">31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-32">32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-33">33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-34">34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-35">35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-36">36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-37">37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-38">38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-39">39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-40">40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-41">41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-42">42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-43">43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-44">44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-45">45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-46">46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-47">47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-48">48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-49">49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-50">50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-51">51</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-52">52</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-53">53</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#f92672">*</span> <span style="color:#111">Prepare</span> <span style="color:#111">the</span> <span style="color:#111">global</span> <span style="color:#111">input</span> <span style="color:#111">file</span> <span style="color:#111">to</span> <span style="color:#111">provide</span> <span style="color:#111">earnings</span> <span style="color:#111">surprise</span> <span style="color:#111">quantiles</span>
</span></span><span style="display:flex;"><span><span style="color:#111">import</span> <span style="color:#111">delimited</span> <span style="color:#111">cq_tsymbol_date</span><span style="color:#f92672">.</span><span style="color:#111">txt</span><span style="color:#111">,</span> <span style="color:#111">clear</span>
</span></span><span style="display:flex;"><span><span style="color:#111">rename</span> <span style="color:#111">v1</span> <span style="color:#111">sym_root</span>
</span></span><span style="display:flex;"><span><span style="color:#111">rename</span> <span style="color:#111">v2</span> <span style="color:#111">date</span>
</span></span><span style="display:flex;"><span><span style="color:#111">rename</span> <span style="color:#111">v3</span> <span style="color:#111">surprise</span>
</span></span><span style="display:flex;"><span><span style="color:#111">tostring</span> <span style="color:#111">date</span><span style="color:#111">,</span> <span style="color:#111">force</span> <span style="color:#111">replace</span>
</span></span><span style="display:flex;"><span><span style="color:#111">transferdate3</span> <span style="color:#111">date</span> <span style="color:#d88200">&#34;YMD&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span> <span style="color:#111">group</span> <span style="color:#111">the</span> <span style="color:#111">observations</span> <span style="color:#111">to</span> <span style="color:#111">three</span> <span style="color:#111">ordered</span> <span style="color:#111">groups</span> <span style="color:#111">based</span> <span style="color:#111">on</span> <span style="color:#111">earnings</span> <span style="color:#111">surprises</span>
</span></span><span style="display:flex;"><span><span style="color:#111">xtile</span> <span style="color:#111">qsurprise</span><span style="color:#f92672">=</span><span style="color:#111">surprise</span><span style="color:#111">,</span> <span style="color:#111">nq</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">save</span> <span style="color:#111">cq_tsymbol_date</span><span style="color:#111">,</span> <span style="color:#111">replace</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span> <span style="color:#111">clean</span> <span style="color:#111">the</span> <span style="color:#111">sas</span> <span style="color:#111">outputs</span><span style="color:#111">,</span> <span style="color:#111">set</span> <span style="color:#111">the</span> <span style="color:#111">panel</span>
</span></span><span style="display:flex;"><span><span style="color:#111">cap</span> <span style="color:#111">program</span> <span style="color:#111">drop</span> <span style="color:#111">cleanraw</span>
</span></span><span style="display:flex;"><span><span style="color:#111">cap</span> <span style="color:#111">program</span> <span style="color:#111">define</span> <span style="color:#111">cleanraw</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">import</span> <span style="color:#111">delimited</span> <span style="color:#111">QuoteSpread_</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">1</span><span style="color:#d88200">&#39;.csv, clear</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">g</span> <span style="color:#111">xid</span> <span style="color:#f92672">=</span> <span style="color:#111">date</span><span style="color:#f92672">+</span><span style="color:#111">sym_root</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">encode</span> <span style="color:#111">xid</span><span style="color:#111">,</span> <span style="color:#111">g</span><span style="color:#111">(</span><span style="color:#111">xcode</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">xtset</span> <span style="color:#111">xcode</span> <span style="color:#111">min</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">tsfill</span><span style="color:#111">,</span> <span style="color:#111">full</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">xfill</span> <span style="color:#111">sym_root</span> <span style="color:#111">date</span> <span style="color:#111">xid</span><span style="color:#111">,</span> <span style="color:#111">i</span><span style="color:#111">(</span><span style="color:#111">xcode</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">foreach</span> <span style="color:#00a8c8">var</span> <span style="color:#111">of</span> <span style="color:#111">varlist</span> <span style="color:#111">bid</span> <span style="color:#111">ask</span> <span style="color:#111">midquote</span> <span style="color:#111">quotedspread_dollar</span> <span style="color:#111">quotedspread_percent</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">by</span> <span style="color:#111">xcode</span><span style="color:#111">:</span> <span style="color:#111">replace</span> <span style="color:#960050;background-color:#1e0010">`</span><span style="color:#00a8c8">var</span><span style="color:#d88200">&#39;=`var&#39;</span><span style="color:#111">[</span><span style="color:#111">_n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#00a8c8">if</span> <span style="color:#960050;background-color:#1e0010">`</span><span style="color:#00a8c8">var</span><span style="color:#d88200">&#39;==.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">foreach</span> <span style="color:#00a8c8">var</span> <span style="color:#111">of</span> <span style="color:#111">varlist</span> <span style="color:#111">bid</span> <span style="color:#111">ask</span> <span style="color:#111">midquote</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">by</span> <span style="color:#111">xcode</span><span style="color:#111">:</span> <span style="color:#111">g</span> <span style="color:#960050;background-color:#1e0010">`</span><span style="color:#00a8c8">var</span><span style="color:#d88200">&#39;_deltaprc=`var&#39;</span><span style="color:#f92672">/</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#00a8c8">var</span><span style="color:#d88200">&#39;[1]-1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">foreach</span> <span style="color:#00a8c8">var</span> <span style="color:#111">of</span> <span style="color:#111">varlist</span> <span style="color:#f92672">*</span><span style="color:#111">depth</span><span style="color:#f92672">*</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">by</span> <span style="color:#111">xcode</span><span style="color:#111">:</span> <span style="color:#111">replace</span> <span style="color:#960050;background-color:#1e0010">`</span><span style="color:#00a8c8">var</span><span style="color:#d88200">&#39;=0 if `var&#39;</span><span style="color:#f92672">==.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">transferdate3</span> <span style="color:#111">date</span> <span style="color:#d88200">&#34;DMY&#34;</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#111">joinby</span> <span style="color:#111">sym_root</span> <span style="color:#111">date</span> <span style="color:#111">using</span> <span style="color:#111">cq_tsymbol_date</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#111">save</span> <span style="color:#111">QuoteSpread_</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">1</span><span style="color:#d88200">&#39;, replace</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">end</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">cleanraw</span> <span style="color:#111">officialcompletenbbo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span><span style="color:#111">cleanraw</span> <span style="color:#111">cleanednnbos</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span> <span style="color:#111">plot</span> <span style="color:#111">stylized</span> <span style="color:#111">patterns</span>
</span></span><span style="display:flex;"><span><span style="color:#111">use</span> <span style="color:#111">QuoteSpread_officialcompletenbbo</span><span style="color:#111">,</span> <span style="color:#111">replace</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">collapse</span> <span style="color:#111">(</span><span style="color:#111">mean</span><span style="color:#111">)</span> <span style="color:#111">bid</span> <span style="color:#111">ask</span> <span style="color:#111">midquote</span> <span style="color:#f92672">*</span><span style="color:#111">spread</span><span style="color:#f92672">*</span> <span style="color:#f92672">*</span><span style="color:#111">depth</span><span style="color:#f92672">*</span> <span style="color:#f92672">*</span><span style="color:#111">deltaprc</span><span style="color:#f92672">*</span><span style="color:#111">,</span> <span style="color:#111">by</span><span style="color:#111">(</span><span style="color:#111">qsurprise</span> <span style="color:#111">min</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span> <span style="color:#111">plot</span> <span style="color:#111">the</span> <span style="color:#111">quote</span> <span style="color:#111">price</span> <span style="color:#111">changes</span> <span style="color:#00a8c8">for</span> <span style="color:#111">positive</span><span style="color:#f92672">/</span><span style="color:#111">negative</span> <span style="color:#111">news</span>
</span></span><span style="display:flex;"><span><span style="color:#111">graph</span> <span style="color:#111">twoway</span> <span style="color:#111">(</span><span style="color:#111">line</span> <span style="color:#111">bid_deltaprc</span> <span style="color:#111">min</span> <span style="color:#00a8c8">if</span> <span style="color:#111">qsurprise</span><span style="color:#f92672">==</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span><span style="color:#f92672">||</span><span style="color:#111">(</span><span style="color:#111">line</span> <span style="color:#111">midquote_deltaprc</span> <span style="color:#111">min</span> <span style="color:#00a8c8">if</span> <span style="color:#111">qsurprise</span><span style="color:#f92672">==</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span><span style="color:#f92672">||</span><span style="color:#111">(</span><span style="color:#111">line</span> <span style="color:#111">ask_deltaprc</span> <span style="color:#111">min</span> <span style="color:#00a8c8">if</span> <span style="color:#111">qsurprise</span><span style="color:#f92672">==</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span><span style="color:#f92672">||</span><span style="color:#111">(</span><span style="color:#111">line</span> <span style="color:#111">midquote_deltaprc</span> <span style="color:#111">min</span> <span style="color:#00a8c8">if</span> <span style="color:#111">qsurprise</span><span style="color:#f92672">==</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span> <span style="color:#00a8c8">if</span> <span style="color:#111">inrange</span><span style="color:#111">(</span><span style="color:#111">min</span><span style="color:#111">,</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">239</span><span style="color:#111">),</span> <span style="color:#111">legend</span><span style="color:#111">(</span><span style="color:#111">label</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span> <span style="color:#d88200">&#34;Bid Price - Bad News&#34;</span><span style="color:#111">)</span> <span style="color:#111">label</span><span style="color:#111">(</span> <span style="color:#ae81ff">2</span> <span style="color:#d88200">&#34;Midquote Price - Bad News&#34;</span><span style="color:#111">)</span> <span style="color:#111">label</span><span style="color:#111">(</span> <span style="color:#ae81ff">3</span> <span style="color:#d88200">&#34;Ask Price - Good News&#34;</span><span style="color:#111">)</span> <span style="color:#111">label</span><span style="color:#111">(</span> <span style="color:#ae81ff">4</span> <span style="color:#d88200">&#34;Midquote Price - Good News&#34;</span><span style="color:#111">)</span> <span style="color:#111">ring</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#111">al</span><span style="color:#111">(</span><span style="color:#111">bottom</span><span style="color:#111">)</span> <span style="color:#111">j</span><span style="color:#111">(</span><span style="color:#111">right</span><span style="color:#111">)</span> <span style="color:#111">size</span><span style="color:#111">(</span><span style="color:#111">small</span><span style="color:#111">))</span>  <span style="color:#111">graphregion</span><span style="color:#111">(</span><span style="color:#111">color</span><span style="color:#111">(</span><span style="color:#111">white</span><span style="color:#111">))</span> <span style="color:#111">xtitle</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Minute Relative to 4:00 p.m.&#34;</span><span style="color:#111">)</span> <span style="color:#111">ytitle</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Quote Price Changes Relative to 3:59 p.m.&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary</h2>
<p>In this blog post, I display a workflow of conducting minute-level price discovery analysis in the after-hours market. Although the post uses the more prevalent after-hours earnings announcements in the recent years as the motivating example, the techniques introduced should also suffice for the exploration of other material news likely released in the after-hours, such as conference calls, analysts&rsquo; recommendations, SEC disclosures, and so on. In addition, the granularity of the analysis could also be easily extended to a higher frequency, such as the second level or beyond, depending the readers&rsquo; research needs.</p>
<h2 id="reference">Reference</h2>
<ol>
<li>Patell, James M., and Mark A. Wolfson. &ldquo;Good news, bad news, and the intraday timing of corporate disclosures.&rdquo; <em>The Accounting review</em> (1982): 509-527.</li>
<li>Chan, Kam Fong, and Terry Marsh. &ldquo;Overnight post-earnings announcement drift and SEC Form 8-K disclosures.&rdquo; <em>Available at SSRN</em> (2024).</li>
<li>Lewis, Michael. <em>Flash boys: a Wall Street revolt</em>. WW Norton &amp; Company, 2014.</li>
<li>Barclay, Michael J., and Terrence Hendershott. &ldquo;Liquidity externalities and adverse selection: Evidence from trading after hours.&rdquo; <em>The Journal of Finance</em> 59, no. 2 (2004): 681-710.</li>
<li>Bryzgalova, Svetlana, Anna Pavlova, and Taisiya Sikorskaya. &ldquo;Retail trading in options and the rise of the big three wholesalers.&rdquo; <em>The Journal of Finance</em> 78, no. 6 (2023): 3465-3514.</li>
<li>deHaan, Ed, Jiacui Li, and Edward M. Watts. &ldquo;Retail bond investors and credit ratings.&rdquo; <em>Journal of Accounting and Economics</em> 76, no. 1 (2023): 101587.</li>
<li>Gregoire, Vincent, and Charles Martineau. &ldquo;How is earnings news transmitted to stock prices?.&rdquo; <em>Journal of Accounting Research</em> 60, no. 1 (2022): 261-297.</li>
<li>Hu, Danqi, and Andrew Stephan. &ldquo;News at the Bell and a Level Playing Field.&rdquo; <em>The Accounting Review</em> 97, no. 6 (2022): 357-384.</li>
<li>Holden, Craig W., and Stacey Jacobsen. &ldquo;Liquidity measurement problems in fast, competitive markets: Expensive and cheap solutions.&rdquo; <em>The Journal of Finance</em> 69, no. 4 (2014): 1747-1785.</li>
</ol>


                

                
                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/get-insights-into-labor-market-with-glassdoor/" data-toggle="tooltip" data-placement="top" title="Get Insights into Workplace Environment Through the Lens of Glassdoor">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                </ul>
                

                


            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">                  
                    
                    <li>
                        <a href="mailto:m.xu@fs.de">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    <li>
                        <a href="https://twitter.com/xumj2021">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    

		            
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/xumj2021">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/mengjie-xu-37410712b/">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    
                    
                    
            
            
            
           
                   <li>
                       <a href='' rel="alternate" type="application/rss+xml" title="Democratize Data For Insights" >
                           <span class="fa-stack fa-lg">
                               <i class="fas fa-circle fa-stack-2x"></i>
                               <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
            
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; Mengjie Xu 2024
                    
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>






</body>
</html>
